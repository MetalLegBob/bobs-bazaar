rules:
  # ═══════════════════════════════════════════════════════════
  # Solana/Anchor Security Rules for The Fortress Phase 0.5
  # ═══════════════════════════════════════════════════════════

  # --- Arithmetic Safety ---

  - id: fortress-unchecked-arithmetic-add
    languages: [rust]
    patterns:
      - pattern: $X + $Y
      - pattern-not: $X.checked_add($Y)
      - pattern-not: $X.saturating_add($Y)
      - pattern-not: $X.wrapping_add($Y)
      - pattern-not: $X.overflowing_add($Y)
    message: >
      Unchecked addition detected. In Rust release builds, integer overflow
      wraps silently. Use checked_add(), saturating_add(), or explicit
      overflow handling.
    severity: WARNING
    metadata:
      fortress-category: arithmetic
      fortress-risk: HIGH
      fortress-ep: EP-015, EP-016
      cwe: CWE-190

  - id: fortress-unchecked-arithmetic-sub
    languages: [rust]
    patterns:
      - pattern: $X - $Y
      - pattern-not: $X.checked_sub($Y)
      - pattern-not: $X.saturating_sub($Y)
      - pattern-not: $X.wrapping_sub($Y)
      - pattern-not: $X.overflowing_sub($Y)
    message: >
      Unchecked subtraction detected. Integer underflow wraps to large
      values in release builds. Use checked_sub() or saturating_sub().
    severity: WARNING
    metadata:
      fortress-category: arithmetic
      fortress-risk: HIGH
      fortress-ep: EP-015, EP-016
      cwe: CWE-191

  - id: fortress-unchecked-arithmetic-mul
    languages: [rust]
    patterns:
      - pattern: $X * $Y
      - pattern-not: $X.checked_mul($Y)
      - pattern-not: $X.saturating_mul($Y)
    message: >
      Unchecked multiplication detected. Overflow risk especially with
      token amounts and price calculations.
    severity: WARNING
    metadata:
      fortress-category: arithmetic
      fortress-risk: HIGH
      fortress-ep: EP-015
      cwe: CWE-190

  - id: fortress-dangerous-cast
    languages: [rust]
    pattern-either:
      - pattern: $EXPR as u64
      - pattern: $EXPR as u32
      - pattern: $EXPR as u16
      - pattern: $EXPR as u8
      - pattern: $EXPR as i64
      - pattern: $EXPR as i32
    message: >
      Type cast may truncate or change sign. Use try_into() with
      error handling instead of bare `as` casts.
    severity: WARNING
    metadata:
      fortress-category: arithmetic
      fortress-risk: MEDIUM
      fortress-ep: EP-017
      cwe: CWE-681

  # --- Panic / DoS ---

  - id: fortress-unwrap-in-program
    languages: [rust]
    pattern: $EXPR.unwrap()
    message: >
      unwrap() will panic on None/Err, causing transaction failure.
      In instruction handlers this is a DoS vector. Use ok_or() or
      map_err() with proper error types.
    severity: WARNING
    metadata:
      fortress-category: error-handling
      fortress-risk: MEDIUM
      fortress-ep: EP-084, EP-085
      cwe: CWE-754

  - id: fortress-expect-in-program
    languages: [rust]
    pattern: $EXPR.expect($MSG)
    message: >
      expect() will panic on None/Err. Same risk as unwrap() but
      with a message. Use proper error handling instead.
    severity: WARNING
    metadata:
      fortress-category: error-handling
      fortress-risk: MEDIUM
      fortress-ep: EP-084
      cwe: CWE-754

  # --- Account Validation ---

  - id: fortress-unchecked-account
    languages: [rust]
    pattern: "UncheckedAccount<'info>"
    message: >
      UncheckedAccount bypasses Anchor's automatic validation.
      Requires manual owner, signer, and type checks.
      Verify the /// CHECK: comment explains why this is safe.
    severity: WARNING
    metadata:
      fortress-category: account-validation
      fortress-risk: HIGH
      fortress-ep: EP-001, EP-002, EP-003
      cwe: CWE-284

  - id: fortress-raw-account-info
    languages: [rust]
    pattern: "AccountInfo<'info>"
    message: >
      Raw AccountInfo without Anchor type safety. All validation
      must be done manually. Prefer typed Anchor accounts.
    severity: INFO
    metadata:
      fortress-category: account-validation
      fortress-risk: MEDIUM
      fortress-ep: EP-001

  # --- CPI Safety ---

  - id: fortress-raw-invoke
    languages: [rust]
    pattern: solana_program::program::invoke(...)
    message: >
      Raw invoke() CPI call detected. Ensure the target program ID
      is validated. Prefer Anchor's CpiContext with Program<'info, T>
      type checking.
    severity: WARNING
    metadata:
      fortress-category: cpi
      fortress-risk: HIGH
      fortress-ep: EP-042, EP-043
      cwe: CWE-346

  - id: fortress-raw-invoke-signed
    languages: [rust]
    pattern: solana_program::program::invoke_signed(...)
    message: >
      Raw invoke_signed() CPI with PDA signer. Verify program ID
      is validated and PDA seeds are correct. Signer seeds grant
      authority to the called program.
    severity: WARNING
    metadata:
      fortress-category: cpi
      fortress-risk: HIGH
      fortress-ep: EP-042, EP-044
      cwe: CWE-346

  - id: fortress-remaining-accounts
    languages: [rust]
    pattern: ctx.remaining_accounts
    message: >
      remaining_accounts passes untyped accounts dynamically.
      Each account must be manually validated for owner, type,
      and signer status. Common source of type confusion attacks.
    severity: WARNING
    metadata:
      fortress-category: account-validation
      fortress-risk: HIGH
      fortress-ep: EP-003, EP-011
      cwe: CWE-20

  # --- Initialization ---

  - id: fortress-init-if-needed
    languages: [rust]
    pattern: init_if_needed
    message: >
      init_if_needed allows re-calling initialization logic on
      existing accounts. Verify the instruction handles both
      first-init and re-init paths correctly. Historical source
      of reinitialization attacks.
    severity: WARNING
    metadata:
      fortress-category: state-machine
      fortress-risk: MEDIUM
      fortress-ep: EP-075, EP-076
      cwe: CWE-665
